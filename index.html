<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau Besoins Production</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #007BFF;
      color: white;
      padding: 15px;
    }
    h1 {
      margin: 0;
    }
    main.colonnes {
      display: flex;
      justify-content: space-around;
      margin: 20px;
    }
    section.colonne {
      flex: 1;
      margin: 0 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .carte {
      background: #f9f9f9;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.demande {
      background: #28a745;
      color: white;
      font-weight: bold;
    }
    button.cloture {
      background: #dc3545;
      color: white;
      margin-top: 5px;
    }
    #formulaire-container {
      display: none;
      max-width: 500px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #formulaire-container h2 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #formulaire-container button[type="submit"] {
      background: #007BFF;
      color: white;
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>
<body class="mode-affichage">
  <header>
    <h1>üìä Besoins de Production</h1>
    <div>
      <button class="demande" onclick="toggleForm()">‚ûï Lancer une demande</button>
      <span id="horloge"></span>
    </div>
  </header>

  <!-- Formulaire cach√© -->
  <div id="formulaire-container">
    <h2>Ajouter un besoin</h2>
    <form id="form-besoin">
      <label for="categorie">Cat√©gorie</label>
      <select id="categorie" required>
        <option value="methode">M√©thodes</option>
        <option value="qualite">Qualit√©</option>
        <option value="controle">Contr√¥le</option>
      </select>

      <label for="programme">Programme concern√©</label>
      <input type="text" id="programme" placeholder="Ex: Ligne A" required>

      <label for="commentaire">Commentaire</label>
      <textarea id="commentaire" rows="3" placeholder="D√©crire le besoin..." required></textarea>

      <label for="auteur">Votre nom</label>
      <input type="text" id="auteur" placeholder="Nom du superviseur" required>

      <button type="submit">Ajouter besoin</button>
    </form>
  </div>

  <main class="colonnes">
    <section class="colonne methode">
      <h2>üõ†Ô∏è M√©thodes</h2>
      <div id="col-methode" class="liste-cartes"></div>
    </section>

    <section class="colonne qualite">
      <h2>‚úÖ Qualit√©</h2>
      <div id="col-qualite" class="liste-cartes"></div>
    </section>

    <section class="colonne controle">
      <h2>üîç Contr√¥le</h2>
      <div id="col-controle" class="liste-cartes"></div>
    </section>
  </main>

  <script>
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDG4nSTlJjYZiQrqcryhy-cEIkxUBkgi-c",
      authDomain: "suivi-besoins-prod.firebaseapp.com",
      projectId: "suivi-besoins-prod",
      storageBucket: "suivi-besoins-prod.firebasestorage.app",
      messagingSenderId: "214097049405",
      appId: "1:214097049405:web:d91b0e4f31077907ea7754"
    };

    // Initialisation
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Horloge
    setInterval(() => {
      document.getElementById("horloge").textContent = new Date().toLocaleString();
    }, 1000);

    // Toggle affichage formulaire
    function toggleForm() {
      const form = document.getElementById("formulaire-container");
      form.style.display = form.style.display === "none" ? "block" : "none";
    }

    // G√©n√©rer un ID unique pour le PC (stock√© une fois en localStorage)
    function getPcId() {
      let id = localStorage.getItem("pcId");
      if (!id) {
        id = "PC-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("pcId", id);
      }
      return id;
    }

    // Cl√¥turer un besoin
    async function cloturerBesoin(idDoc) {
      const nom = prompt("Qui cl√¥ture ce besoin ?");
      if (!nom) return;

      try {
        await db.collection("besoins").doc(idDoc).update({
          statut: "clos",
          cloturePar: nom,
          pcId: getPcId(),
          clotureDate: firebase.firestore.Timestamp.now()
        });
        alert("‚úÖ Besoin cl√¥tur√© !");
      } catch (error) {
        console.error("Erreur cl√¥ture :", error);
        alert("‚ùå Impossible de cl√¥turer.");
      }
    }

    // Envoi formulaire
    document.getElementById("form-besoin").addEventListener("submit", async (e) => {
      e.preventDefault();

      const categorie = document.getElementById("categorie").value;
      const programme = document.getElementById("programme").value;
      const commentaire = document.getElementById("commentaire").value;
      const auteur = document.getElementById("auteur").value;

      try {
        await db.collection("besoins").add({
          categorie,
          programme,
          commentaire,
          auteur,
          date: firebase.firestore.Timestamp.now(),
          statut: "ouvert"
        });

        alert("‚úÖ Besoin ajout√© avec succ√®s !");
        e.target.reset();
        document.getElementById("formulaire-container").style.display = "none";
      } catch (error) {
        console.error("Erreur :", error);
        alert("‚ùå Erreur lors de l‚Äôajout du besoin.");
      }
    });

    // Affichage temps r√©el
    db.collection("besoins").orderBy("date").onSnapshot(snapshot => {
      document.getElementById("col-methode").innerHTML = "";
      document.getElementById("col-qualite").innerHTML = "";
      document.getElementById("col-controle").innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const carte = document.createElement("div");
        carte.classList.add("carte");

        let contenu = `
          <strong>${data.programme}</strong>
          <p>${data.commentaire}</p>
          <small>Par ${data.auteur} ‚Äî ${data.date.toDate().toLocaleString()}</small>
        `;

        if (data.statut === "ouvert") {
          contenu += `<br><button class="cloture" onclick="cloturerBesoin('${doc.id}')">‚úÖ Cl√¥turer</button>`;
        } else if (data.statut === "clos") {
          contenu += `
            <p style="color:green;"><strong>Cl√¥tur√©</strong> par ${data.cloturePar}
            (${data.pcId}) le ${data.clotureDate.toDate().toLocaleString()}</p>
          `;
        }

        carte.innerHTML = contenu;

        if (data.categorie === "methode") document.getElementById("col-methode").appendChild(carte);
        if (data.categorie === "qualite") document.getElementById("col-qualite").appendChild(carte);
        if (data.categorie === "controle") document.getElementById("col-controle").appendChild(carte);
      });
    });
  </script>
</body>
</html>
