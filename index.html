<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Besoins de Production</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
    header {
      background:#222; color:white; padding:15px 20px;
      display:flex; justify-content:space-between; align-items:center;
    }
    header h1 { margin:0; font-size:24px; }
    header button {
      margin-left:20px; padding:10px 15px; border:none;
      border-radius:8px; background:#007BFF; color:white; font-weight:bold; cursor:pointer;
    }
    header button:hover { background:#0056b3; }
    main { display:flex; height:calc(100vh - 70px); }
    section { flex:1; padding:10px; overflow-y:auto; color:white; }
    .methode { background:#1e73be; }
    .qualite { background:#2e7d32; }
    .controle { background:#c62828; }
    h2 { text-align:center; }
    .carte {
      background:white; color:#333; border-radius:8px;
      padding:10px; margin:10px 0; box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .carte strong { display:block; font-size:16px; margin-bottom:5px; }
    .carte small { color:#555; font-size:12px; display:block; margin-top:5px; }
    .btn-cloture {
      display:block; width:100%; margin-top:10px; padding:6px;
      border:none; border-radius:6px; cursor:pointer;
      background:#dc3545; color:white; font-weight:bold;
    }
    .btn-cloture:hover { background:#a71d2a; }
    /* Formulaire modal */
    #form-container {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center;
    }
    #form-besoin {
      background:white; padding:20px; border-radius:10px; width:400px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
    }
    #form-besoin label { font-weight:bold; display:block; margin-top:10px; }
    #form-besoin input, #form-besoin select, #form-besoin textarea {
      width:100%; padding:8px; margin-top:5px; border-radius:6px; border:1px solid #ccc;
    }
    #form-besoin button {
      width:100%; padding:10px; margin-top:15px; border:none;
      border-radius:6px; background:#007BFF; color:white; font-weight:bold; cursor:pointer;
    }
    #form-besoin button:hover { background:#0056b3; }
    .close-btn { background:#dc3545 !important; }
    .close-btn:hover { background:#a71d2a !important; }
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <header>
    <h1>üìä Besoins de Production</h1>
    <div>
      <span id="horloge"></span>
      <button onclick="ouvrirForm()">‚ûï Lancer une demande</button>
    </div>
  </header>

  <main>
    <section class="methode">
      <h2>üõ†Ô∏è M√©thodes</h2>
      <div id="col-methode"></div>
    </section>
    <section class="qualite">
      <h2>‚úÖ Qualit√©</h2>
      <div id="col-qualite"></div>
    </section>
    <section class="controle">
      <h2>üîç Contr√¥le</h2>
      <div id="col-controle"></div>
    </section>
  </main>

  <!-- Formulaire modal -->
  <div id="form-container">
    <form id="form-besoin">
      <h2>‚ûï Ajouter un besoin</h2>

      <label for="categorie">Cat√©gorie</label>
      <select id="categorie" required>
        <option value="methode">M√©thodes</option>
        <option value="qualite">Qualit√©</option>
        <option value="controle">Contr√¥le</option>
      </select>

      <label for="programme">Programme concern√©</label>
      <input type="text" id="programme" placeholder="Ex: Ligne A" required>

      <label for="commentaire">Commentaire</label>
      <textarea id="commentaire" rows="3" placeholder="D√©crire le besoin..." required></textarea>

      <label for="auteur">Votre nom</label>
      <input type="text" id="auteur" placeholder="Nom du superviseur" required>

      <button type="submit">‚úÖ Ajouter besoin</button>
      <button type="button" class="close-btn" onclick="fermerForm()">‚ùå Annuler</button>
    </form>
  </div>

  <script>
    // üîπ Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDG4nSTlJjYZiQrqcryhy-cEIkxUBkgi-c",
      authDomain: "suivi-besoins-prod.firebaseapp.com",
      projectId: "suivi-besoins-prod",
      storageBucket: "suivi-besoins-prod.firebasestorage.app",
      messagingSenderId: "214097049405",
      appId: "1:214097049405:web:d91b0e4f31077907ea7754"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Horloge
    setInterval(() => {
      document.getElementById("horloge").textContent = new Date().toLocaleString();
    }, 1000);

    // üîπ R√©cup√©rer IP
    let userIP = "";
    fetch("https://api.ipify.org?format=json")
      .then(res => res.json())
      .then(data => userIP = data.ip);

    // üîπ Affichage temps r√©el
    db.collection("besoins").orderBy("date").onSnapshot(snapshot => {
      document.getElementById("col-methode").innerHTML = "";
      document.getElementById("col-qualite").innerHTML = "";
      document.getElementById("col-controle").innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const carte = document.createElement("div");
        carte.classList.add("carte");

        let contenu = `
          <strong>${data.programme}</strong>
          <p>${data.commentaire}</p>
          <small>Par ${data.auteur} ‚Äî ${data.date.toDate().toLocaleString()}</small>
        `;

        if (data.statut === "clotur√©") {
          contenu += `
            <small>‚úÖ Cl√¥tur√© par ${data.cloturePar} (${data.clotureIP}) le ${data.clotureDate.toDate().toLocaleString()}</small>
          `;
        } else {
          contenu += `<button class="btn-cloture" onclick="cloturerBesoin('${doc.id}')">Cl√¥turer</button>`;
        }

        carte.innerHTML = contenu;

        if (data.categorie === "methode") document.getElementById("col-methode").appendChild(carte);
        if (data.categorie === "qualite") document.getElementById("col-qualite").appendChild(carte);
        if (data.categorie === "controle") document.getElementById("col-controle").appendChild(carte);
      });
    });

    // üîπ Cl√¥turer un besoin
    async function cloturerBesoin(id) {
      const cloturePar = prompt("Votre nom pour cl√¥ture ?");
      if (!cloturePar) return;

      try {
        await db.collection("besoins").doc(id).update({
          statut: "clotur√©",
          cloturePar,
          clotureIP: userIP,
          clotureDate: firebase.firestore.Timestamp.now()
        });
        alert("‚úÖ Besoin cl√¥tur√© avec succ√®s !");
      } catch (e) {
        console.error(e);
        alert("‚ùå Erreur lors de la cl√¥ture");
      }
    }

    // üîπ Gestion formulaire ajout
    document.getElementById("form-besoin").addEventListener("submit", async (e) => {
      e.preventDefault();
      const categorie = document.getElementById("categorie").value;
      const programme = document.getElementById("programme").value;
      const commentaire = document.getElementById("commentaire").value;
      const auteur = document.getElementById("auteur").value;

      try {
        await db.collection("besoins").add({
          categorie,
          programme,
          commentaire,
          auteur,
          date: firebase.firestore.Timestamp.now(),
          statut: "ouvert"
        });
        alert("‚úÖ Besoin ajout√© !");
        fermerForm();
        e.target.reset();
      } catch (error) {
        console.error(error);
        alert("‚ùå Erreur lors de l‚Äôajout du besoin.");
      }
    });

    // Fonctions ouverture/fermeture formulaire
    function ouvrirForm() { document.getElementById("form-container").style.display = "flex"; }
    function fermerForm() { document.getElementById("form-container").style.display = "none"; }
  </script>
</body>
</html>
